<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="shortcut icon" href="../assets/images/favicon.png" type="image/png">
    <title>Cinfolympics 2021 Season</title>
</head>
<body>
    <main class="container-fluid p-0">
        <div class="content p-0">
            <div class="row mb-4">
                <nav class="navbar navbar-light bg-light">
                    <div class="container">
                        <a class="navbar-brand" href="#">
                            <img src="../assets/images/favicon.png" alt="" width="50" height="50">
                        </a>
                        <div class="col-4 m-auto">
                            <div class="form-group">
                                <select name="teamname" id="teamname" class="form-control">

                                </select>
                            </div>
                        </div>
                    </div>
                </nav>
                
            </div>
            <div class="row m-0 p-3" id="card-container">

            </div>
        </div>

        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-secondary text-uppercase" id="staticBackdropLabel">Confirm Selection...?</h5>
                    <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                </div>
                <div class="modal-body p-0" id="modal-card">
                    <!-- <div class="card m-auto col-12 bg-white rounded">                
                        <div class="card-body">
                            <img class="d-flex align-items-center justify-content-center" src="../assets/images/uploads/TeamName/SamuelTamunobarasinipiri.jpeg" alt="avatar" style="width:100%; height:25rem; box-sizing:border-box; background-size:cover; object-fit:cover;">
                        </div>
                        <div class="card-footer">
                            <h6 class="card-title text-secondary">FullName: <span class="text-uppercase" data-fullname="fullname"> </span></h6>
                            <h6 class="text-secondary">Department: <span class="text-uppercase department" data-department="department"> </span></h6>
                            <h6 class="text-secondary">Position: <span class="text-uppercase" data-position="position"> </span></h6>
                        </div>
                    </div> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary col-4" data-bs-dismiss="modal" id="btn_dismiss">Dismiss</button>
                    <button type="button" class="btn btn-success col-4" id="confirm_btn">Confirm</button>
                </div>
                </div>
            </div>
        </div>
    </main>
    <script src="../assets/js/jquery-3.5.1.min.js"></script>
    <script src="../assets/js/jQueryBlockUI/jqueryblockui.js"></script>
    <script src="../assets/js/jquery.msgbox.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/boxicons@latest/dist/boxicons.js"></script>

    <script>
    
        $(document).ready(function(){
            $("#btn_players_submit").click(function(e){
                addPlayers(e)
            });

            $("#teamname").change(function(e){
                var team = $("#teamname :selected").text();
                window.localStorage.setItem("team", team);
            });

            $("#player-card").click(function(e){
                console.log(e.target.children);
            });

            $("#confirm_btn").click(function(e){
                updatePlayers(e);
            });

            setInterval(function(e){
                // getUpdatedPlayer();
            }, 3000);

            getTeams();
            getPlayers();
        });
        
        function getTeams() {  
            var url = "../../api/routindex.php";    
            $.ajax({
                url: url,
                type: "POST",
                data: {
                    "action": "get_teams"
                },
                success: function (res) {
                    $.unblockUI();
                    var json = JSON.parse(res);
                    console.log(json);
                    if (json.statuscode == 0) {
                        var items = json.data;
                        $('#teamname').html = "";
                        console.log(items);
                        $('#teamname').append($('<option>').text("Select your Team").attr('value', ""));
                        $.each(items, function(i, obj){
                            console.log(obj.teamName, obj.teamId);
                            $('#teamname').append($('<option>').text(obj.teamName).attr('value', obj.teamId)).trigger('change');
                        }); 
                    } else {
                        $.prompt(json.status);
                    }
                }
            });
        } 

        function getPlayers() {  
            var url = "../../api/routindex.php";    
            $.ajax({
                url: url,
                type: "POST",
                data: {
                    "action": "get_players"
                },
                success: function (res) {
                    $.unblockUI();
                    var json = JSON.parse(res);
                    console.log(json);
                    if (json.statuscode == 0) {
                        $.each(json.data, function(nx, val){
                            console.log(nx, val);  
                            var fulname = val.lastName + ' ' + val.FirstName;                  
                            var card = `<div class="card m-auto col-3 col-md-3 shadow-sm bg-white rounded p-0" id="player-card" style="cursor: pointer; transform:scale(0.85)">                
                                    <div class="card-body">
                                        <img class="d-flex align-items-center justify-content-center" src="../assets/images/uploads/TeamName/SamuelTamunobarasinipiri.jpeg" alt="avatar" style="width:100%; height:15rem; box-sizing:border-box; background-size:cover; object-fit:cover;">
                                    </div>
                                    <div class="card-footer">
                                        <p class="card-title text-secondary">FullName: <span class="text-uppercase" id="fullname${nx}">${fulname}</span></p>
                                        <p class="text-secondary">Department: <span class="text-uppercase" id="department${nx}">${val.department} </span></p>
                                        <p class="text-secondary">Position: <span class="text-uppercase" id="position${nx}">${val.position} </span></p>
                                        <p id="playerid${nx}">${val.pId}</p>
                                        <button class="btn btn-outline-dark btn-sm col-12" id="checkselection${nx}" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Select this person</button>
                                    </div>
                                </div>`;    
                            // $("#card-container").html("");
                            $("#card-container").append(card);
                            $('#checkselection'+nx).click(function(e){
                                if ($("#teamname").val() == "" || $("#teamname").text() == "Select your Team") {
                                    $.prompt("Please select your Team Name first before you start choosing team members.")
                                    $("#confirm_btn").toggle();
                                } else {
                                    $("#confirm_btn").toggle();
                                    var modalCard = `<div class="card m-auto col-12 bg-white rounded p-0" id="player-card" style="cursor: pointer; transform:scale(0.85)">                
                                            <div class="card-body">
                                                <img class="d-flex align-items-center justify-content-center" src="../assets/images/uploads/TeamName/SamuelTamunobarasinipiri.jpeg" alt="avatar" style="width:100%; height:15rem; box-sizing:border-box; background-size:cover; object-fit:cover;">
                                            </div>
                                            <div class="card-footer">
                                                <p class="card-title text-secondary">FullName: <span class="text-uppercase" id="fullname${nx}">${fulname}</span></p>
                                                <p class="text-secondary">Department: <span class="text-uppercase" id="department${nx}">${val.department} </span></p>
                                                <p class="text-secondary">Position: <span class="text-uppercase" id="position${nx}">${val.position} </span></p>                                                                                
                                            </div>
                                        </div>`;                                    
                                        window.localStorage.setItem("playerid", val.pId);
                                    $("#modal-card").html("");
                                    $("#modal-card").append(modalCard); 
                                }                                
                            });
                        });
                    } else {
                        $.prompt(json.status);
                    }
                }
            });
        } 

        function getUpdatedPlayer() {  
            var url = "../../api/routindex.php";    
            $.ajax({
                url: url,
                type: "POST",
                data: {
                    "action": "get_updated_players"
                },
                success: function (res) {
                    $.unblockUI();
                    var json = JSON.parse(res);
                    console.log(json);
                    if (json.statuscode == 0) {
                        $("#card-container").load(window.location.href + " #card-container" );
                        getPlayers();
                        console.log(json.data);
                    } else {
                        $.prompt(json.status);
                    }
                }
            });
        } 

        function updatePlayers(e) { 
            e.preventDefault(); 
            var url = "../../api/routindex.php";    
            $.ajax({
                url: url,
                type: "POST",
                data: {
                    "teamid": $("#teamname").val(),
                    "playerid": window.localStorage.getItem("playerid"),
                    "action": "update_players"
                },
                success: function (res) {
                    $.unblockUI();
                    var json = JSON.parse(res);
                    console.log(json);
                    if (json.statuscode == 0) {
                        $.prompt(json.status); 
                    } else {
                        $.prompt(json.status);
                    }
                }
            });
        } 

        function addPlayers(e) {
            // alert(e.target.id);
            e.preventDefault();
            var formData = new FormData(playerForm);
            formData.append("action", "addplayer");
            formData.append("teamname", window.localStorage.getItem("team"));
            var url = "../../api/routindex.php";    
            
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    $.unblockUI();
                    var json = JSON.parse(res);
                    console.log(json);
                    if (json.statuscode == 0) {
                        $.prompt(json.status); 
                    } else {
                        $.prompt(json.status);
                    }
                }
            });
        } 

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                
                reader.onload = function(e) {
                $('#photopreview').attr('src', e.target.result);
                }
                
                reader.readAsDataURL(input.files[0]); // convert to base64 string
            }
        }

        $("#playerphoto").change(function() {
            readURL(this);
            $('#displayplayer').css("display", "flex");
        });        
    </script>
</body>
</html>